# nanbu-nourin 仕様書

- ドキュメント版: v0.2
- 更新日: 2025-10-14
- 作成者: TBD

## 1. 概要
- 沖縄県南部農林土木事務所向け「特記仕様書」作成支援ツール（静的Web）。
- 既存の特記仕様書テキストを解析してテンプレート化し、不要項目を除外して再採番した印刷用HTMLを生成する。

## 2. 目的・背景
- 現状はテンプレートから手作業で削除・編集し、番号不整合や削除漏れが発生している。
- 本ツールは「構造の整合（階層・採番・体裁）」を自動で担保し、作業時間とヒューマンエラーを低減する。

## 3. ステークホルダーと読者
- 事業責任者/依頼者: 南部農林土木事務所
- プロダクト/開発: 水土里ネットおきなわ
- 運用/サポート: 水土里ネットおきなわ

## 4. 用語定義
- 特記仕様書: 発注に際し、共通仕様書に対する個別条件を明記する文書。
- 条項（条）: 「第n条（見出し）」形式の章要素。
- 業務概要: 文頭の表形式情報（業務名/場所/工期など）。

## 5. スコープ
- In: 既存テキストの解析→テンプレート生成、テンプレート読込→不要項目選択、再採番、印刷用HTML生成、ダウンロード（JSON/MD/HTML）。
- Out: 内容の論理整合や法令適合性の自動チェック（例: 条件A削除時にB/Cも必ず削除などのルール推論）。
- チェック範囲: 構造と形式（必須セクション有無、階層、採番、禁止記号、文字コード）。

## 6. ユースケース / ユーザーストーリー
- UC-01（解析→テンプレ化）: 既存の特記仕様書テキストを貼付→見出し/条/表を自動抽出→テンプレJSONをダウンロード。
- UC-02（選択→出力）: テンプレJSONをアップロード→不要条項をチェック除外→再採番→印刷用HTML/Markdownをダウンロード。
- UC-03（プレビュー/印刷）: ブラウザ内で印刷プレビューし、所定の余白・ページ区切りで出力。

## 7. 機能要件（FR）
- FR-001: 既存文の構造解析（業務概要表/第n条/箇条書き/強調）。
- FR-002: テンプレート生成（JSONスキーマ準拠）。
- FR-003: テンプレート読込と階層チェック表示（ツリー/折りたたみ）。
- FR-004: 不要項目チェック除外（親子伝播の確認ダイアログ）。
- FR-005: 自動採番（第n条、(1)、1)、- の階層）。
- FR-006: 印刷用HTML生成（A4、余白、ページ番号、見出し固定）。
- FR-007: ダウンロード（template.json、tokki.html、tokki.md）。
- FR-008: バリデーション（必須「業務概要」「第1条（目的）」「適用関連」存在）。
- FR-009: ローカル保存（下書きをLocalStorageに保存/読込）。
- FR-010: オフライン動作（Service Worker 任意、なければブラウザ標準でも可）。
 - FR-011: 括弧見出しと条番号の結合（直前行が「（見出し）」で次行が「第 n 条」の場合、見出し=括弧内文字列として採用）。
 - FR-012: 条番号の空白許容（「第 1 条」「第1条」いずれも検出）。

受け入れ条件（例）
- AC-001: 貼付サンプル（本書サンプル相当）を解析し、業務概要3項目と第1～第23条を抽出できる。
- AC-002: 任意の条を除外した場合、以降の条番号が連番で再採番される（第22条→第21条など）。
- AC-003: 印刷用HTMLはA4でページ番号、見出し・条の改ページ制御が効く。

## 8. 画面 / UX
- 1ページ内タブ構成: 「解析」「テンプレ」「選択・出力」「設定」。
- 解析: テキスト貼付→プレビュー→テンプレJSONを生成・DL。
- テンプレ: JSONのツリー表示、項目名/optionalフラグ編集（任意）。
- 選択・出力: 階層チェックボックス、プレビュー、HTML/MDのDLボタン。
- 設定: 採番/印刷/言語/余白/フォント/章見出しルールの調整。

## 9. 非機能要件（NFR）
- 配布: GitHub Pagesで配信可能な完全静的サイト。
- 互換性: Google Chrome 最新版。
- 性能: サンプル3万字の解析/再描画が2秒以内（Chrome Mシリーズ端末目安）。
- 可用性: ネットワーク不通でも主要機能が動作（貼付→出力）。
- セキュリティ: 入力データは端末内のみで処理。外部送信なし。

## 10. データモデル（テンプレJSON スキーマ草案）
```json
{
  "$schema": "https://example.local/schema/tokki.json",
  "version": "1.0",
  "meta": {
    "title": "特記仕様書",
    "agency": "沖縄県南部農林土木事務所",
    "createdAt": "",
    "source": "paste|file"
  },
  "overview": {
    "type": "table",
    "fields": [
      { "key": "業務名", "value": "", "required": true },
      { "key": "業務場所", "value": "", "required": true },
      { "key": "工期", "value": "", "required": true }
    ]
  },
  "articles": [
    {
      "no": 1,
      "title": "目的",
      "optional": false,
      "bodyMd": "農業用ため池における防災工事の必要性判断のため...",
      "children": []
    }
  ]
}
```

注: テンプレはJSONで保持し、編集・出力時はMarkdown/HTMLを生成。

## 11. 入出力仕様
- 入力（貼付）: プレーンテキスト/Markdown。業務概要の表（タブ/全角スペース区切り許容）と条項を抽出。
  - 入力（読込）: `template.json`（上記スキーマ）。
  - 出力: `template.json`/`tokki.html`/`tokki.md`。文字コードはUTF-8。
  - 強調/箇条書き: `**太字**`、`-`/`・`/`(1)`/`1)` に対応し階層化。
 - 条見出しの抽出パターン:
   - 形式A: 同一行に「第n条（見出し）」
   - 形式B: 直前行に「（見出し）」、次行に「第 n 条」→ 見出しを結合して1条として扱う
 - 条番号の検出正規表現例: `^第\s*([0-9]+)\s*条`（半角スペース任意を許容）

## 12. 採番ルール
- 条の書式: `第{n}条（{見出し}）`。削除時は後続条を繰り上げ連番整備。
- 段落番号: `(1) → 1) → -` の順に深くする（最大3階層、可変）。
- 禁止: 同階層で数字スキップ、ゼロ始まり、重複番号。
- 付録: 任意で「付録A, B…」の章扱い（採番から除外）。

## 13. バリデーション / エラーハンドリング
- 構造検証: 必須フィールド（業務名/場所/工期/第1条）が未設定なら警告。
- 形式検証:
  - 条番号: `^第\s*([0-9]+)\s*条` に合致しない場合は要確認として表示。
  - 見出し: 形式Aは同一行の括弧内/ 形式Bは直前行の括弧内を見出しとして採用。いずれも不在なら未設定警告。
- 例外処理: JSON不正は読込時に位置と理由を表示し、読込を中止。

## 14. 印刷仕様（CSS）
- 用紙: A4、余白上下20mm左右15mm、フォント: Noto Sans JP。
- ノンブル: フッタにページ番号（中央）。
- 改ページ: 条頭で優先的に `page-break-before: always`（初回除く）。
- スタイル: 条見出しは太字16px、本文14px、表は罫線あり。

## 15. セキュリティ / 権限
- 認証なし、権限なし。ブラウザ内処理、外部送信なし。
- クリップボードアクセスはユーザー操作時のみ使用。

## 16. 外部連携
- なし。

## 17. ログ / 監視
- なし（デバッグはブラウザコンソールで実施）。

## 18. 環境 / 対応対象
- Google Chrome 最新版（Windows/Mac）。日本語フォント（Noto系）の利用を想定。

## 19. 運用 / リリース
- GitHub Pages に `index.html` 一式を配置して公開。
- バージョニング: 本SPECとUIの簡易バージョンをフッタに表示。

## 20. リスク / 前提 / 制約
- リスク: 多様な過去文書の表現揺れにより解析精度が低下する可能性。
- 緩和: 可視化（抽出結果プレビュー）と手動修正、解析ルールの調整設定を提供。
- 制約: 完全オフライン前提のため外部NLP等は未使用。

## 21. マイルストーン（提案）
- M1: テンプレJSON確定、採番/正規表現ルール確定。
- M2: 解析→テンプレ生成実装、基本テスト（サンプル対応）。
- M3: テンプレ読込→選択→HTML/MD出力、印刷CSS実装。
- M4: 調整/アクセシビリティ/軽微改善→Pages公開。

## 22. サンプル適用（抜粋）
サンプル文書をテンプレに落とし込む例（抜粋）。

```json
{
  "overview": {
    "type": "table",
    "fields": [
      { "key": "業務名", "value": "久米島ため池劣化診断調査・耐震照査業務（R7-2）" },
      { "key": "業務場所", "value": "久米島町 各ため池" },
      { "key": "工期", "value": "契約日の翌開庁日 ～ 令和8年3月31日" }
    ]
  },
  "articles": [
    { "no": 1, "title": "目的", "optional": false, "bodyMd": "農業用ため池における防災工事の必要性判断のため、ため池工事特措法に位置付けられた以下の評価を実施する。\n\n- 劣化状況評価\n- 地震・豪雨耐性評価のうち、地震によるもの" },
    { "no": 2, "title": "共通仕様書の適用", "optional": false, "bodyMd": "本業務は、沖縄県農林水産部制定の各共通仕様書および関係法規に基づき実施し、併せて本特記仕様書による。\n\n- 設計業務共通仕様書【農業農村整備編】（令和7年10月）\n- 地質・土質調査業務共通仕様書【農業農村整備編】（令和7年10月）\n- 測量業務共通仕様書【農業農村整備編】（令和7年10月）\n- 磁気探査業務共通仕様書【農業農村整備編】（令和7年10月）" },
    { "no": 3, "title": "場所", "optional": true, "bodyMd": "対象ため池および評価種別は次のとおり（別紙図面参照）。\n\n- 劣化状況評価：上溝1号、上溝2号\n- 地震耐性評価：上溝1号、上溝2号" },
    { "no": 4, "title": "管理技術者の資格", "optional": false, "bodyMd": "「設計共通仕様書」1-6第3項による（当該業務に該当する部門・選択科目を満たすこと）。" },
    { "no": 5, "title": "照査技術者の資格", "optional": true, "bodyMd": "「設計共通仕様書」1-7第2項による（当該業務に該当する部門・選択科目を満たすこと）。" },
    { "no": 6, "title": "管理技術者の直接的雇用関係", "optional": true, "bodyMd": "管理技術者は受注者との直接雇用であること（契約締結時点）。…" },
    { "no": 7, "title": "配置技術者の確認", "optional": true, "bodyMd": "業務計画書に配置技術者の立場・役割を明記…（アグリス登録 等）。" },
    { "no": 8, "title": "履行報告", "optional": true, "bodyMd": "「設計共通仕様書」1-33に基づき、毎月5日までに…" },
    { "no": 9, "title": "保険加入", "optional": true, "bodyMd": "受注者は…保険に加入済である旨を業務計画書に明示…" },
    { "no": 10, "title": "業務委託料変更時の落札率適用", "optional": true, "bodyMd": "変更業務委託料＝変更設計額×落札率…" },
    { "no": 11, "title": "業務環境改善", "optional": true, "bodyMd": "「業務環境改善実施要領（案）」の3.取組内容について…" },
    { "no": 12, "title": "貸与資料", "optional": true, "bodyMd": "貸与資料：ため池台帳…一括貸与/返納…" },
    { "no": 13, "title": "適用図書", "optional": true, "bodyMd": "各共通仕様書に加え、以下の図書を最新版で適用…" },
    { "no": 14, "title": "作業項目", "optional": true, "bodyMd": "本業務における作業項目は別紙のとおり。" },
    { "no": 15, "title": "地質・土質調査業務", "optional": true, "bodyMd": "調査位置・項目は…磁気探査…安全確保…" },
    { "no": 16, "title": "測量業務", "optional": true, "bodyMd": "範囲・項目は現地踏査を踏まえ事前協議で決定。" },
    { "no": 17, "title": "業務計画書", "optional": true, "bodyMd": "「設計共通仕様書」1-11に基づき…" },
    { "no": 18, "title": "地元関係者との交渉等", "optional": true, "bodyMd": "受益者向け地元説明会…関係機関連携…" },
    { "no": 19, "title": "打合せ", "optional": true, "bodyMd": "初回/中間/最終。中間段階での概要説明対応…数量変更時の報告…" },
    { "no": 20, "title": "情報共有システムの使用", "optional": true, "bodyMd": "指定の情報共有システムを使用。沖縄県CALSシステム使用許諾料の支払い等。" },
    { "no": 21, "title": "地盤情報データベースへの登録", "optional": true, "bodyMd": "ボーリング成果を国土地盤情報データベースに登録。公開・利用の可否は発注者と協議。" },
    { "no": 22, "title": "成果物", "optional": false, "bodyMd": "電子納品、デジタル写真管理情報基準、CAD製図基準…\n\n- 報告書（A4）2部\n- 土質調査報告書（A4）2部（該当時）\n- 測量成果簿（A4）2部（該当時）\n- 電子成果品 2部\n\n製本は分冊を極力回避し、長期使用に耐える装丁。" },
    { "no": 23, "title": "一般承諾事項", "optional": true, "bodyMd": "本特記仕様書に定めのない事項や疑義は、受発注者で協議…" }
  ]
}
```

## 23. 変更履歴
- 2025-10-14: v0.2 サンプル反映、要件具体化、JSONスキーマ草案追加
